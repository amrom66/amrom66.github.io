<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="linjinbao">
  <meta name="description" content="打工人日记">
  <meta name="keywords" content="博客 个人 日记">
  
  <link rel="prev" href="https://linjinbao.github.io/2019/20191108jvm-zhi-ling-xue-xi/" />
  <link rel="next" href="https://linjinbao.github.io/2019/20191109svn-docker-zhi-zuo-chi-xu-ji-cheng-huan-jing/" />
  <link rel="canonical" href="https://linjinbao.github.io/2019/svn-docker%E5%88%B6%E4%BD%9C%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           使用svn&#43;docker搭建持续集成环境 | 打工人日记
       
  </title>
  <meta name="title" content="使用svn&#43;docker搭建持续集成环境 | 打工人日记">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/linjinbao.github.io"
    },
    "articleSection" : "posts",
    "name" : "使用svn\x2bdocker搭建持续集成环境",
    "headline" : "使用svn\x2bdocker搭建持续集成环境",
    "description" : "使用svn\x2bdocker搭建持续集成环境 功能描述： 通过使用svn\x2bdocker部署一套自动打包系统，使得项目的打包部署更加简单，只需要做一步操作： 在本地svn上面执行commit操作即可，svn服务器端收到推送后，会利用post-commit钩子将新的项目内容同步到目标路径，同时执行docker打包脚本，被docker部署脚本\n准备工具  svn服务端 docker和tomcat基础镜像  实现逻辑  使用svn进行项目更新包的同步 svn hooks完成更新包和tomcat内容的同步 自动化脚本由post-commit调用；完成镜像版本的更新、镜像启动等操作  第一步：安装svn服务端，并且在本地checkout出一份，同时在服务器找个文件夹checkout一份 这一步比较简单，可以看我另一篇博客学习，地址如下：Linux SVN服务端搭建\n第二步：配置svn hooks实现自动同步，将版本库中文件自动checkout到docker待打包目录 post-commit文件内容示例如下：\necho \x26#34;#####开始提交 #####\x26#34; \x26gt;\x26gt; \/tmp\/svn.log #svn日志\recho \x26#34;提交时间为：\x26#34; \x2b `date` \x26gt;\x26gt;\/tmp\/svn.log\recho \x26#34;提交人：\x26#34; \x2b `whoami` \x26gt;\x26gt;\/tmp\/svn.log\r\/usr\/bin\/svn update \/opt\/tomcat\/webapps\/lin --username *** --password *** --no-auth-cache\r# 执行docker脚本\rsudo sh \/opt\/tomcat\/webapps\/lin\/docker.sh #调用docker.sh脚本，完成镜像包的制作，容器的制作启动等操作\r第三步： 编写docker.sh脚本 docker.sh示例： 由于虚拟机空间有限，镜像包的制作逻辑没有遵循版本号递增的规则，此处每次进行重新构建的操作，如果是服务器环境，可以选择利用版本号做区分，或者和我的注释一样，使用时间戳进行标记\n#!\/bin\/sh\r# 版本号\r#version=`date \x2b%s`\r#version=`docker images | grep linjinbao666\/svntest | awk \x26#39;{print $2\x2b1}\x26#39; | awk \x26#39;{print $1\x2b1}\x26#39;`\r#version=`docker images | grep linjinbao666\/svntest|head -n -1 | awk \x26#39;{print $2\x2b1}\x26#39;`\rcd \/opt\/tomcat\/webapps\/lin\rsystemctl restart docker \x26gt;\x26gt; \/tmp\/docker.",
    "inLanguage" : "en-us",
    "author" : "linjinbao",
    "creator" : "linjinbao",
    "publisher": "linjinbao",
    "accountablePerson" : "linjinbao",
    "copyrightHolder" : "linjinbao",
    "copyrightYear" : "2019",
    "datePublished": "2019-11-09 00:00:00 \x2b0000 UTC",
    "dateModified" : "2019-11-09 00:00:00 \x2b0000 UTC",
    "url" : "https:\/\/linjinbao.github.io\/2019\/svn-docker%E5%88%B6%E4%BD%9C%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83\/",
    "wordCount" : "423",
    "keywords" : [ "Linux","docker", "打工人日记"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://linjinbao.github.io">打工人日记</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://linjinbao.github.io">打工人日记</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">使用svn&#43;docker搭建持续集成环境</h1>
        <div class="post-meta">
                作者： <a itemprop="name" href="https://linjinbao.github.io" rel="author">linjinbao</a> 时间： 
                <span class="post-time">
                 <time datetime=9119-11-09 itemprop="datePublished">November 9, 2019</time>
                </span>
                分类： 
                
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <h1 id="使用svndocker搭建持续集成环境">使用svn+docker搭建持续集成环境</h1>
<p>功能描述：
通过使用svn+docker部署一套自动打包系统，使得项目的打包部署更加简单，只需要做一步操作：
在本地svn上面执行commit操作即可，svn服务器端收到推送后，会利用post-commit钩子将新的项目内容同步到目标路径，同时执行docker打包脚本，被docker部署脚本</p>
<h2 id="准备工具">准备工具</h2>
<ol>
<li>svn服务端</li>
<li>docker和tomcat基础镜像</li>
</ol>
<h2 id="实现逻辑">实现逻辑</h2>
<ol>
<li>使用svn进行项目更新包的同步</li>
<li>svn hooks完成更新包和tomcat内容的同步</li>
<li>自动化脚本由post-commit调用；完成镜像版本的更新、镜像启动等操作</li>
</ol>
<h2 id="第一步安装svn服务端并且在本地checkout出一份同时在服务器找个文件夹checkout一份">第一步：安装svn服务端，并且在本地checkout出一份，同时在服务器找个文件夹checkout一份</h2>
<p>这一步比较简单，可以看我另一篇博客学习，地址如下：<a href="https://linjinbao666.github.io/2019/svn%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/">Linux SVN服务端搭建</a></p>
<h2 id="第二步配置svn-hooks实现自动同步将版本库中文件自动checkout到docker待打包目录">第二步：配置svn hooks实现自动同步，将版本库中文件自动checkout到docker待打包目录</h2>
<p>post-commit文件内容示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">echo <span style="color:#e6db74">&#34;#####开始提交 #####&#34;</span> &gt;&gt; /tmp/svn.log  <span style="color:#75715e">#svn日志</span>
echo <span style="color:#e6db74">&#34;提交时间为：&#34;</span> + <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> &gt;&gt;/tmp/svn.log
echo <span style="color:#e6db74">&#34;提交人：&#34;</span> + <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> &gt;&gt;/tmp/svn.log
/usr/bin/svn update /opt/tomcat/webapps/lin --username *** --password *** --no-auth-cache
<span style="color:#75715e"># 执行docker脚本</span>
sudo sh /opt/tomcat/webapps/lin/docker.sh      <span style="color:#75715e">#调用docker.sh脚本，完成镜像包的制作，容器的制作启动等操作</span>
</code></pre></div><h2 id="第三步-编写dockersh脚本">第三步： 编写docker.sh脚本</h2>
<p>docker.sh示例：
由于虚拟机空间有限，镜像包的制作逻辑没有遵循版本号递增的规则，此处每次进行重新构建的操作，如果是服务器环境，可以选择利用版本号做区分，或者和我的注释一样，使用时间戳进行标记</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span><span style="color:#75715e"># 版本号</span>
<span style="color:#75715e">#version=`date +%s`</span>
<span style="color:#75715e">#version=`docker images | grep linjinbao666/svntest | awk &#39;{print $2+1}&#39; | awk &#39;{print $1+1}&#39;`</span>
<span style="color:#75715e">#version=`docker images | grep linjinbao666/svntest|head -n -1 | awk &#39;{print $2+1}&#39;`</span>

cd /opt/tomcat/webapps/lin

systemctl restart docker &gt;&gt; /tmp/docker.log

echo <span style="color:#e6db74">&#34;##########1.关闭上一个容器&#34;</span> &gt;&gt; /tmp/docker.log
docker stop svntest &gt;&gt; /tmp/docker.log
sleep 5
echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> +  <span style="color:#e6db74">&#34;###########上一个容器已经关闭####&#34;</span> &gt;&gt; /tmp/docker.log 

echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;##########2.删除上次的容器##&#34;</span> &gt;&gt; /tmp/docker.log
docker rm svntest &gt;&gt;/tmp/docker.log
sleep 5
echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;#############上一个容器删除####&#34;</span> &gt;&gt; /tmp/docker.log

echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;#######3.开始删除镜像##########&#34;</span> &gt;&gt; /tmp/docker.log
docker rmi linjinbao666/svntest:latest &gt;&gt; /tmp/docker.log
sleep 15
echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;########删除上次镜像成功#######&#34;</span> &gt;&gt; /tmp/docker.log

echo <span style="color:#e6db74">&#34;#########4.开始重新制作docker镜像包#########&#34;</span> &gt;&gt; /tmp/docker.log
sudo docker build -f ./dockerFile -t linjinbao666/svntest --no-cache . &gt;&gt; /tmp/docker.log
sleep 20
echo <span style="color:#e6db74">&#34;##########制作完成#########&#34;</span> &gt;&gt; /tmp/docker.log
echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> &gt;&gt; /tmp/docker.log

<span style="color:#75715e"># docker stop $(docker ps -aq)</span>
<span style="color:#75715e"># sleep 10</span>
<span style="color:#75715e"># docker rm $(docker ps -aq)</span>

echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;5.###########创建并启动新的容器####### &#34;</span> &gt;&gt; /tmp/docker.log
<span style="color:#75715e"># docker run -dit -p 8088:8080 --name svntest linjinbao666/svntest</span>

sudo docker run -dit -p8088:8080 --name svntest linjinbao666/svntest &gt;&gt; /tmp/docker.log
sleep 5

echo <span style="color:#e6db74">`</span>date<span style="color:#e6db74">`</span> + <span style="color:#e6db74">&#34;######容器启动完成#####&#34;</span>&gt;&gt;/tmp/docker.log


<span style="color:#75715e"># echo `date` + &#34;##########删除标签为none的镜像####&#34;&gt;&gt; /tmp/docker.log</span>

<span style="color:#75715e"># docker images | grep none | awk &#39;{print $3}&#39; | xargs docker rmi</span>

<span style="color:#75715e"># echo `date` + &#34;############清理镜像成功#####&#34;&gt;&gt; /tmp/docker.log</span> 

<span style="color:#75715e"># sleep 15</span> 
</code></pre></div><h2 id="第四步编写dockerfile脚本">第四步：编写dockerFile脚本</h2>
<p>dockerFile示例：</p>
<pre><code class="language-code" data-lang="code">
FROM tomcat

COPY . /usr/local/tomcat/webapps/lin

CMD [&quot;catalina.sh&quot;, &quot;run&quot;]

EXPOSE 8080
</code></pre><h2 id="操作说明">操作说明</h2>
<p>在本地svn文件夹修改文件后，进行commit操作，服务器端自动重新构建全新版本的项目，无需进行多余操作</p>
<p>注意点：</p>
<ol>
<li>注意dockerFile的编写规范，要求待打包的内容必须在上下问路径</li>
<li>注意shell脚本的执行路径，即脚本<code>docker.sh</code>中的<code>cd /opt/tomcat/webapps/lin</code>，该语句将工作目录切换到路项目文件同级目录，缺少这一句，docker命令执行会出现找不到文件的问题</li>
</ol>
<h2 id="带图演示">带图演示</h2>
<p>第一次index.html的内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#f92672">html</span>&gt;
&lt;<span style="color:#f92672">head</span>&gt;
	&lt;<span style="color:#f92672">title</span>&gt;&lt;/<span style="color:#f92672">title</span>&gt;
	&lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">body</span>&gt;
	第一次提交
	第二次提交，修改了页面内同

&lt;/<span style="color:#f92672">body</span>&gt;
&lt;/<span style="color:#f92672">html</span>&gt;
</code></pre></div><p>提交页面截图：
<img src="https://raw.githubusercontent.com/linjinbao666/resources/master/amromPicture/%E7%AC%AC%E4%B8%80%E6%AC%A1%E4%BF%AE%E6%94%B9index.html%E5%B9%B6commit.png" alt="提交页面截图"></p>
<p>浏览器访问截图：
<img src="https://raw.githubusercontent.com/linjinbao666/resources/master/amromPicture/%E7%AC%AC%E4%B8%80%E6%AC%A1commit%E5%90%8E%E8%AE%BF%E9%97%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E9%A1%B5%E9%9D%A2.png" alt="第一次浏览器访问截图"></p>
<p>修改index.html页面的内容后提交
第二次提交页面截图：
<img src="https://raw.githubusercontent.com/linjinbao666/resources/master/amromPicture/%E4%BF%AE%E6%94%B9%E5%86%85%E5%AE%B9%E5%90%8E%E6%8F%90%E4%BA%A4.png" alt="第二次提交截图"></p>
<p>第二次浏览器访问截图：
<img src="https://raw.githubusercontent.com/linjinbao666/resources/master/amromPicture/%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%8F%90%E4%BA%A4%E5%90%8E%E5%88%B7%E6%96%B0%E6%B5%8F%E8%A7%88%E5%99%A8%E9%A1%B5%E9%9D%A2.png" alt="第二次访问浏览器"></p>
<h3 id="解释">解释</h3>
<p>两次提交过程中，我并没有登录服务器进行手动重构镜像，全部由其自动化完成</p>
<h3 id="dockerlog内容截取">docker.log内容截取：</h3>
<pre><code class="language-code" data-lang="code">##########1.关闭上一个容器
svntest
2019年 11月 04日 星期一 05:25:53 CST + ###########上一个容器已经关闭####
2019年 11月 04日 星期一 05:25:53 CST + ##########2.删除上次的容器##
svntest
2019年 11月 04日 星期一 05:25:58 CST + #############上一个容器删除####
2019年 11月 04日 星期一 05:25:58 CST + #######3.开始删除镜像##########
Untagged: linjinbao666/svntest:latest
Deleted: sha256:1443c6b69c386a3b6fc6ed44f4f14e0908748b0f51ccd0076da371239d17e099
Deleted: sha256:af62668e9b8abce6dd5310e3c7d65fb927c95a92297e8ceb51f1cfee7684f470
Deleted: sha256:57bee29050664264b6a34bb2686c5065c454b76a5e4698741e8b1cbf93aa3bea
Deleted: sha256:f2abd86d82492bb73cba146bf6f5058d082ae5bb521d3c99e2d350d81d3f0e71
2019年 11月 04日 星期一 05:26:13 CST + ########删除上次镜像成功#######
#########4.开始重新制作docker镜像包#########
Sending build context to Docker daemon  1.03 MB
Step 1/4 : FROM tomcat
 ---&gt; 882487b8be1d
Step 2/4 : COPY . /usr/local/tomcat/webapps/lin
 ---&gt; fa7128130bd2
Removing intermediate container f7d201e5ddea
Step 3/4 : CMD catalina.sh run
 ---&gt; Running in c10feb7bc7cd
 ---&gt; 52eb3d3b929e
Removing intermediate container c10feb7bc7cd
Step 4/4 : EXPOSE 8080
 ---&gt; Running in 3aeb1e06ec54
 ---&gt; 452efcac24bd
Removing intermediate container 3aeb1e06ec54
Successfully built 452efcac24bd
##########制作完成#########
2019年 11月 04日 星期一 05:26:34 CST
2019年 11月 04日 星期一 05:26:34 CST + 5.###########创建并启动新的容器#######
e1c219214186b625d0b01fef0cc7db482a09427e47857306c41943f38aa42d51
2019年 11月 04日 星期一 05:26:40 CST + ######容器启动完成#####
</code></pre>
    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>linjinbao </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://linjinbao.github.io/2019/svn-docker%E5%88%B6%E4%BD%9C%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83/>https://linjinbao.github.io/2019/svn-docker%E5%88%B6%E4%BD%9C%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%8E%AF%E5%A2%83/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>标签: 
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/linux/">
                    #Linux</a></span>
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/docker/">
                    #docker</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">返回</a></span> · 
                <span><a href="https://linjinbao.github.io">主页</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://linjinbao.github.io/2019/20191108jvm-zhi-ling-xue-xi/" class="prev" rel="prev" title="jvm指令学习"><i class="iconfont icon-left"></i>&nbsp;jvm指令学习</a>
         
        
        <a href="https://linjinbao.github.io/2019/20191109svn-docker-zhi-zuo-chi-xu-ji-cheng-huan-jing/" class="next" rel="next" title="使用svn&#43;docker搭建持续集成环境">使用svn&#43;docker搭建持续集成环境&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
		  
		  
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://linjinbao.github.io">linjinbao</a>  </span> 
         

         
		 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
