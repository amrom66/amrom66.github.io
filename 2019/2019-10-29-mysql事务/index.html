<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="linjinbao66">
  <meta name="description" content="打工人日记">
  <meta name="keywords" content="博客 个人 日记">
  
  <link rel="prev" href="https://linjinbao.github.io/2019/2019-10-25-java%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%94%E7%A4%BA/" />
  <link rel="next" href="https://linjinbao.github.io/2019/2019-10-30-mybatis-generator%E4%BD%BF%E7%94%A8/" />
  <link rel="canonical" href="https://linjinbao.github.io/2019/2019-10-29-mysql%E4%BA%8B%E5%8A%A1/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           MySQL 事务 | 打工人日记
       
  </title>
  <meta name="title" content="MySQL 事务 | 打工人日记">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/linjinbao.github.io"
    },
    "articleSection" : "posts",
    "name" : "MySQL 事务",
    "headline" : "MySQL 事务",
    "description" : "2019-10-29-MySQL事务 MySQL事务 什么是事务 事务指的是当 DML 数据修改语句提交给数据库后，要么数据全部成功写入、如若其中某项操作失败则所有数据全部回滚到修改前状态的机制。数据库通过事务保证数据的完整性、一致性。\nACID 一个完整的事务，必然包含了如下4个特性：原子性、一致性、隔离性、持久性。\n   类别 描述     原子性（Atomicity） 事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。   一致性（Consistency） 事务应确保数据库的状态从一个一致状态转变成另一个一致状态。一致状态的含义是数据库应满足完整性约束。   隔离性（Isolation） 多个事务并发执行时，一个事务的执行不影响其他事务的执行   持久性（Durability） 已被提交的事务对数据库的修改应该永久保存在数据库中。    多线程并发事务问题 在多线程环境中，对于同一条数据而言可能有多个线程同时在进行修改操作，即带来了操作冲突。按照并发控制理论，要想解决冲突的问题，可以有如下两种思路：",
    "inLanguage" : "en-us",
    "author" : "linjinbao66",
    "creator" : "linjinbao66",
    "publisher": "linjinbao66",
    "accountablePerson" : "linjinbao66",
    "copyrightHolder" : "linjinbao66",
    "copyrightYear" : "2019",
    "datePublished": "2019-10-29 00:00:00 \x2b0000 UTC",
    "dateModified" : "2019-10-29 00:00:00 \x2b0000 UTC",
    "url" : "https:\/\/linjinbao.github.io\/2019\/2019-10-29-mysql%E4%BA%8B%E5%8A%A1\/",
    "wordCount" : "149",
    "keywords" : [ "MySQL", "打工人日记"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://linjinbao.github.io">打工人日记</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://linjinbao.github.io">打工人日记</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">MySQL 事务</h1>
        <div class="post-meta">
                作者： <a itemprop="name" href="https://linjinbao.github.io" rel="author">linjinbao66</a> 时间： 
                <span class="post-time">
                 <time datetime=29109-10-29 itemprop="datePublished">October 29, 2019</time>
                </span>
                分类： 
                
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h1 id="2019-10-29-mysql事务">2019-10-29-MySQL事务</h1>
<h2 id="mysql事务">MySQL事务</h2>
<h3 id="什么是事务">什么是事务</h3>
<p>事务指的是当 DML 数据修改语句提交给数据库后，要么数据全部成功写入、如若其中某项操作失败则所有数据全部回滚到修改前状态的机制。数据库通过事务保证数据的完整性、一致性。</p>
<h3 id="acid">ACID</h3>
<p>一个完整的事务，必然包含了如下4个特性：<strong>原子性、一致性、隔离性、持久性。</strong></p>
<table>
<thead>
<tr>
<th align="center">类别</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">原子性（Atomicity）</td>
<td align="left">事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</td>
</tr>
<tr>
<td align="center">一致性（Consistency）</td>
<td align="left">事务应确保数据库的状态从一个一致状态转变成另一个一致状态。一致状态的含义是数据库应满足完整性约束。</td>
</tr>
<tr>
<td align="center">隔离性（Isolation）</td>
<td align="left">多个事务并发执行时，一个事务的执行不影响其他事务的执行</td>
</tr>
<tr>
<td align="center">持久性（Durability）</td>
<td align="left">已被提交的事务对数据库的修改应该永久保存在数据库中。</td>
</tr>
</tbody>
</table>
<h3 id="多线程并发事务问题">多线程并发事务问题</h3>
<p>在多线程环境中，对于同一条数据而言可能有多个线程同时在进行修改操作，即带来了操作冲突。按照并发控制理论，要想解决冲突的问题，可以有如下两种思路：</p>
<ol>
<li>避免冲突发生，如串行化，加锁等；</li>
<li>允许冲突发生，即允许数据有多个版本，如使用MVCC</li>
</ol>
<p>同时，多线程事务还存在隔离性的问题，当多个事务并发执行的时候，一个事务中能否感知到另外一个事务中的数据修改。数据库理论中专门定义了一系列的术语来描述：</p>
<table>
<thead>
<tr>
<th align="left">术语</th>
<th align="left">简介</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">脏读</td>
<td align="left">一个事务可以读到另外一个事务中未提交的数据。这往往会造成数据不一致</td>
</tr>
<tr>
<td align="left">不可重复读</td>
<td align="left">同一事务中两次读取同一行，数据不一致的情况称为不可重复读</td>
</tr>
<tr>
<td align="left">幻读</td>
<td align="left">同一事务中通过统计或其他汇总语句统计出来的数据不一致的情况</td>
</tr>
</tbody>
</table>
<p>为解决上述问题，数据库提出了事务隔离级别来与之对应。从下表可以看出，一致性越好，并发能力越差。</p>
<table>
<thead>
<tr>
<th align="left">隔离级别</th>
<th align="left">脏读</th>
<th align="left">不可重复读</th>
<th align="left">幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">读未提交(Read Uncommit)</td>
<td align="left">有</td>
<td align="left">有</td>
<td align="left">有</td>
</tr>
<tr>
<td align="left">读已提交(Read Commit)</td>
<td align="left">无</td>
<td align="left">有</td>
<td align="left">有</td>
</tr>
<tr>
<td align="left">可重复读(Read Uncommit)</td>
<td align="left">无</td>
<td align="left">无</td>
<td align="left">有</td>
</tr>
<tr>
<td align="left">串行化(Read Uncommit)</td>
<td align="left">无</td>
<td align="left">无</td>
<td align="left">无</td>
</tr>
</tbody>
</table>
<h2 id="innodb-事务">InnoDB 事务</h2>
<p>在计算机领域，数据一致性、与数据崩溃恢复通常是通过 WAL（Write Ahead Log） 技术来实现的——用户如果对数据库中的数据就行了修改，必须保证日志先于数据落盘。在InnoDB 引擎中，通过binlog 与redolog 的两段提交的方式（在事务执行前先写redolog，执行结束前写binlog）保证了数据的一致性和完整性，如若数据刷盘的过程中发生了异常，那么当MySQL重启的时候，根据日志对数据进行恢复，就可以还原数据，保证数据的一致性。<strong>在MySQL中，日志文件是最重要的数据，而数据文件反而没有那么重要。</strong></p>
<h2 id="mvcc-机制">MVCC 机制</h2>
<p>InnoDB 引擎是一个多版本存储引擎，它通过保留数据行的旧版本来实现事务。</p>
<h3 id="快照读与当前读">快照读与当前读</h3>
<p>MVCC 中，数据有两种读取形式：</p>
<ul>
<li>快照读：读取的只是当前事务的可见版本，不用加锁。Select 使用的是快照读，因此查询性能可以获得极大的提高。</li>
<li>当前读：读取的是当前版本，需要加锁，Insert、Update、Delete 使用的是当前读。</li>
</ul>
<h3 id="undo-log">Undo Log</h3>
<p>旧版本数据行称作undo日志，这些信息保存在表空间的回滚段里。通常我们的undo日志被用来做两件事：</p>
<ul>
<li>回滚</li>
<li>一致性读</li>
</ul>
<p>undo log 是逻辑上的日志，记录当前事务操作前的该行数据的原始状态。 可分为 <strong>insert undo log</strong>和<strong>update undo log</strong>。</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Insert Undo Log</td>
<td align="left">插入undo log在数据插入的时候产生，仅仅在回滚的时候才会被用到，因为该行是新增的，之前并不存在该数据，因此不存在多版本，可以在事务提交后就可以丢弃。</td>
</tr>
<tr>
<td align="left">Update Undo Log</td>
<td align="left">更新undo log 不仅在回滚时候需要用到，由于其他事务中可能用到了该数据，因此也需要用于一致性读。有可能其他事务也正在处理这条数据，因此只有当该条数据没有事务的时候，才能丢弃这些日志。因此我们需要关注事务的处理时长，如果一个事务长时间得不到释放那么对应的undolog日志就不能够被清除，当吞吐量较大的时候需要占用较大的表空间</td>
</tr>
</tbody>
</table>
<h3 id="数据行格式">数据行格式</h3>
<p>InnoDB 引擎会隐性的为每一行数据都增加如下三个隐藏字段。InnoDB 通过这三个字段的相互配合实现了事务。数据行的格式如下：</p>
<p>DB_ROW_ID DB_TRX_ID DB_ROW_PTR 数据</p>
<p>数据行ID 6字节 上次事务ID，6字节 回滚指针，7字节</p>
<ul>
<li>DB_ROW_ID 即行主键，6个字节，唯一标识一行数据，如若用户没有定义主键，InnoDB内部会自动创建一个行ID当作主键。</li>
<li>DB_TRX_ID 最后操作事务ID，6个字节，记录最后一次操作改行数据的事务ID</li>
<li>DB_ROW_PTR 回滚指针，指向回滚段中一行 undo 日志。</li>
</ul>
<h3 id="delete过程">Delete过程</h3>
<p>在InnoDB 中，<strong>删除操作实际上是被当作一个更新操作来处理</strong>。当我们需要删除一条数据的时候，首先InnoDB在内存中将该数据的删除标识位以及其辅助索引删除标识位都标识为已删除，之后当该数据的undo log 可以被清除的时候，InnoDB 通过purge线程将该数据物理清除。</p>
<p>同样<strong>InnoDB 的物理数据删除也是一个逻辑删除过程</strong>，它仅仅是将该数据行标记为已删除，仅此而已。数据标记为删除并不意味着该数据行所拥有的空间能够立即被复用，后续可以被用到的时候， 该数据列才会被覆盖掉。因此当我们通过delete 方法删除所有数据的时候，我们可以看到.ibd文件的大小并没有减少。这种索引列可以复用却没有被实际使用的现象我们通常称之为索引空洞，解决该问题我们可以通过重建表的方式来对磁盘进行回收。重建命令如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">alert table table_name engine = InnoDB
复制代码
</code></pre></div><h3 id="聚集索引与辅助索引区别">聚集索引与辅助索引区别</h3>
<p>我们知道InnoDB 主键使用了聚集索引。对于聚集索引，叶子节点包含了该数据的所有字段，因此当数据发生变化的时候可以直接对这一数据行进行替换。</p>
<p>对于辅助索引而言，情况可能有点不太一样。 当我们更新了一个辅助索引，InnoDB 首先将之前的索引标记为删除，然后插入新的索引记录，被删除的索引通过 purge 线程在后续被清除。因此如果辅助索引被其他事务更新或删除，覆盖索引将会失效，查询需要回表。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>作者:</span>
                <span>linjinbao66 </span>
                </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>标签: 
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/mysql/">
                    #MySQL</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">返回</a></span> · 
                <span><a href="https://linjinbao.github.io">主页</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://linjinbao.github.io/2019/2019-10-25-java%E5%A0%86%E6%BA%A2%E5%87%BA%E6%BC%94%E7%A4%BA/" class="prev" rel="prev" title="java堆溢出演示"><i class="iconfont icon-left"></i>&nbsp;java堆溢出演示</a>
         
        
        <a href="https://linjinbao.github.io/2019/2019-10-30-mybatis-generator%E4%BD%BF%E7%94%A8/" class="next" rel="next" title="MyBatis Generator 使用">MyBatis Generator 使用&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
		  <div id="utter-container"></div>
    <script src="https://utteranc.es/client.js"
        repo= 'linjinbao/linjinbao.github.io'
        issue-term= 'title'
        label= 'utterance'
        theme= 'github-light'
        crossorigin="anonymous"
        async>
  </script>

    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://linjinbao.github.io">linjinbao66</a>  </span> 
         

         
		 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
