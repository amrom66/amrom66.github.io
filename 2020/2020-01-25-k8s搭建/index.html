<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="linjinbao66">
  <meta name="description" content="打工笔记">
  <meta name="keywords" content="博客 个人 笔记">
  
  <link rel="prev" href="https://linjinbao.github.io/2020/2020-01-24-etcd%E4%BD%BF%E7%94%A8/" />
  <link rel="next" href="https://linjinbao.github.io/2020/2020-01-25-flannel%E7%BD%91%E7%BB%9C/" />
  <link rel="canonical" href="https://linjinbao.github.io/2020/2020-01-25-k8s%E6%90%AD%E5%BB%BA/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           k8s完整搭建文档 | 打工笔记
       
  </title>
  <meta name="title" content="k8s完整搭建文档 | 打工笔记">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/linjinbao.github.io"
    },
    "articleSection" : "posts",
    "name" : "k8s完整搭建文档",
    "headline" : "k8s完整搭建文档",
    "description" : "k8s完整搭建文档 2. 准备事项 机器环境：centos7.6 主节点：192.168.126.135 从节点：192.168.126.136， 192.168.126.137 2.1 机器hostname设置\nhostnamectl set-hostname etcd1 # 192.168.126.135机器执行 hostnamectl set-hostname etcd2 # 192.168.126.136机器执行 hostnamectl set-hostname etcd3 # 192.",
    "inLanguage" : "en-us",
    "author" : "linjinbao66",
    "creator" : "linjinbao66",
    "publisher": "linjinbao66",
    "accountablePerson" : "linjinbao66",
    "copyrightHolder" : "linjinbao66",
    "copyrightYear" : "2020",
    "datePublished": "2020-01-25 00:00:00 \x2b0000 UTC",
    "dateModified" : "2020-01-25 00:00:00 \x2b0000 UTC",
    "url" : "https:\/\/linjinbao.github.io\/2020\/2020-01-25-k8s%E6%90%AD%E5%BB%BA\/",
    "wordCount" : "559",
    "keywords" : [ "k8s","kubernetes","分布式", "打工笔记"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://linjinbao.github.io">打工笔记</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;
                <a href="https://linjinbao.github.io">打工笔记</a>
            </div>
            <div class="menu-toggle">
                <svg t="1618556759902" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1299" width="16" height="16"><path d="M896 1024h-213.333333a128 128 0 0 1-128-128v-213.333333a128 128 0 0 1 128-128h213.333333a128 128 0 0 1 128 128v213.333333a128 128 0 0 1-128 128z m-213.333333-384a42.666667 42.666667 0 0 0-42.666667 42.666667v213.333333a42.666667 42.666667 0 0 0 42.666667 42.666667h213.333333a42.666667 42.666667 0 0 0 42.666667-42.666667v-213.333333a42.666667 42.666667 0 0 0-42.666667-42.666667z m-341.333334 384H128a128 128 0 0 1-128-128v-213.333333a128 128 0 0 1 128-128h213.333333a128 128 0 0 1 128 128v213.333333a128 128 0 0 1-128 128z m-213.333333-384a42.666667 42.666667 0 0 0-42.666667 42.666667v213.333333a42.666667 42.666667 0 0 0 42.666667 42.666667h213.333333a42.666667 42.666667 0 0 0 42.666667-42.666667v-213.333333a42.666667 42.666667 0 0 0-42.666667-42.666667z m768-170.666667h-213.333333a128 128 0 0 1-128-128V128a128 128 0 0 1 128-128h213.333333a128 128 0 0 1 128 128v213.333333a128 128 0 0 1-128 128z m-213.333333-384a42.666667 42.666667 0 0 0-42.666667 42.666667v213.333333a42.666667 42.666667 0 0 0 42.666667 42.666667h213.333333a42.666667 42.666667 0 0 0 42.666667-42.666667V128a42.666667 42.666667 0 0 0-42.666667-42.666667z m-341.333334 384H128a128 128 0 0 1-128-128V128a128 128 0 0 1 128-128h213.333333a128 128 0 0 1 128 128v213.333333a128 128 0 0 1-128 128zM128 85.333333a42.666667 42.666667 0 0 0-42.666667 42.666667v213.333333a42.666667 42.666667 0 0 0 42.666667 42.666667h213.333333a42.666667 42.666667 0 0 0 42.666667-42.666667V128a42.666667 42.666667 0 0 0-42.666667-42.666667z" p-id="1300"></path></svg>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">博客</a>
                
                <a class="menu-item" href="/categories/" title="">分类</a>
                
                <a class="menu-item" href="/tags/" title="">标签</a>
                
                <a class="menu-item" href="/2020/about/" title="关于">关于</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">k8s完整搭建文档</h1>
        <div class="post-meta">
                作者： <a itemprop="name" href="https://linjinbao.github.io" rel="author">linjinbao66</a> 时间： 
                <span class="post-time">
                 <time datetime=25019-01-25 itemprop="datePublished">January 25, 2020</time>
                </span>
                分类： 
                
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h1 id="k8s完整搭建文档">k8s完整搭建文档</h1>
<h2 id="2-准备事项">2. 准备事项</h2>
<p>机器环境：centos7.6 主节点：192.168.126.135 从节点：192.168.126.136， 192.168.126.137 2.1 机器hostname设置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">hostnamectl set-hostname etcd1 # 192.168.126.135机器执行  
hostnamectl set-hostname etcd2 # 192.168.126.136机器执行  
hostnamectl set-hostname etcd3 # 192.168.126.137机器执行
</code></pre></div><p>2.2 机器hosts设置 省略 配置完成如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">cat /etc/hosts:
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4  
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6  
192.168.126.135 etcd1  
192.168.126.136 etcd2  
192.168.126.137 etcd3
</code></pre></div><p>2.3 安装必要的软件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">yum install kubernetes-master etcd flannel -y  # etcd1执行
yum install kubernetes-node etcd docker flannel *rhsm* -y  #etcd2执行
yum install kubernetes-node etcd docker flannel *rhsm* -y  #etcd3执行
</code></pre></div><p>2.4 关闭防火墙，配置软件源</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">systemctl stop firealld  
systemctl disable firewalld  

sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;  
{  
  &#34;registry-mirrors&#34;: [&#34;https://baz6f8j9.mirror.aliyuncs.com&#34;]  
}  
EOF  
sudo systemctl daemon-reload  
sudo systemctl restart docker  

yum install *rhsm*  

wget http://mirror.centos.org/centos/7/os/x86_64/Packages/python-rhsm-certificates-1.19.10-1.el7_4.x86_64.rpm  

rpm2cpio python-rhsm-certificates-1.19.10-1.el7_4.x86_64.rpm | cpio -iv --to-stdout ./etc/rhsm/ca/redhat-uep.pem | tee /etc/rhsm/ca/redhat-uep.pem
</code></pre></div><h2 id="3-etcd集群配置">3. etcd集群配置</h2>
<p>3.1 etcd1配置 配置/etc/etcd/etcd.conf:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# cat /etc/etcd/etcd.conf  
ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;  # 数据存放位置，如果出错，需要删除
ETCD_LISTEN_PEER_URLS=&#34;http://192.168.126.135:2380&#34;  #当前客户端地址
ETCD_LISTEN_CLIENT_URLS=&#34;http://192.168.126.135:2379,http://127.0.0.1:2379&#34;  #当前客户端地址
ETCD_MAX_SNAPSHOTS=&#34;5&#34;  
ETCD_NAME=&#34;etcd1&#34;  #重点，在集群中的名称
ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://192.168.126.135:2380&#34;  #广播地址
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.126.135:2379&#34;  #广播地址
ETCD_INITIAL_CLUSTER=&#34;etcd1=http://192.168.126.135:2380,etcd2=http://192.168.126.136:2380,etcd3=http://192.168.126.137:2380&#34;  #集群所有节点的地址
ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;  #重点，etcd集群名称
ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></div><p>3.2 etcd2配置 配置/etc/etcd/etcd.conf:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;  
ETCD_LISTEN_PEER_URLS=&#34;http://192.168.126.136:2380&#34;  
ETCD_LISTEN_CLIENT_URLS=&#34;http://192.168.126.136:2379,http://127.0.0.1:2379&#34; 
ETCD_MAX_SNAPSHOTS=&#34;5&#34;  
ETCD_NAME=&#34;etcd2&#34;  
ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://192.168.126.136:2380&#34;  
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.126.136:2379&#34;  
ETCD_INITIAL_CLUSTER=&#34;etcd1=http://192.168.126.135:2380,etcd2=http://192.168.126.136:2380,etcd3=http://192.168.126.137:2380&#34;  
ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;  
ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></div><p>3.3 etcd3配置 配置/etc/etcd/etcd.conf:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;  
ETCD_LISTEN_PEER_URLS=&#34;http://192.168.126.137:2380&#34;  
ETCD_LISTEN_CLIENT_URLS=&#34;http://192.168.126.137:2379,http://127.0.0.1:2379&#34; 
ETCD_MAX_SNAPSHOTS=&#34;5&#34;  
ETCD_NAME=&#34;etcd3&#34;  
ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://192.168.126.137:2380&#34;  
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.126.137:2379&#34;  
ETCD_INITIAL_CLUSTER=&#34;etcd1=http://192.168.126.135:2380,etcd2=http://192.168.126.136:2380,etcd3=http://192.168.126.137:2380&#34;  
ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster&#34;  
ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
</code></pre></div><p>3.4 启动并验证etcd集群 在每个机器上分别执行：systemctl start etcd，首次启动会卡顿，因为在等待所有节点加入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# etcdctl member list  
168ae043a1f52da5: name=etcd2 peerURLs=http://192.168.126.136:2380 clientURLs=http://192.168.126.136:2379 isLeader=false  
33049130aa4e4a04: name=etcd3 peerURLs=http://192.168.126.137:2380 clientURLs=http://192.168.126.137:2379 isLeader=false  
e3bf8bcaa9f960b4: name=etcd1 peerURLs=http://192.168.126.135:2380 clientURLs=http://192.168.126.135:2379 isLeader=true
</code></pre></div><h2 id="4-配置kubernetes集群">4. 配置kubernetes集群</h2>
<p>4.1 etcd1配置 apiserver 配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# cat /etc/kubernetes/apiserver  
KUBE_API_ADDRESS=&#34;--insecure-bind-address=0.0.0.0&#34;  ##不能绑定到本地
KUBE_API_PORT=&#34;--port=8080&#34;  
KUBELET_PORT=&#34;--kubelet-port=10250&#34;  
KUBE_ETCD_SERVERS=&#34;--etcd-servers=http://192.168.126.135:2379,http://192.168.126.136:2379,http://192.168.126.137:2379&#34;  ##etcd集群节点地址
KUBE_SERVICE_ADDRESSES=&#34;--service-cluster-ip-range=10.254.0.0/16&#34;  
KUBE_ADMISSION_CONTROL=&#34;--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota&#34;  ##删除了负责权限验证的配置
KUBE_API_ARGS=&#34;&#34;
</code></pre></div><p>config配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# cat /etc/kubernetes/config  
###  
KUBE_LOGTOSTDERR=&#34;--logtostderr=true&#34;  
KUBE_LOG_LEVEL=&#34;--v=0&#34;  
KUBE_ALLOW_PRIV=&#34;--allow-privileged=false&#34;  
KUBE_MASTER=&#34;--master=http://192.168.126.135:8080&#34;  #主节点
</code></pre></div><p>启动：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">systemctl start kube-apiserver   
systemctl start kube-controller-manager  
systemctl start kube-scheduler
</code></pre></div><p>4.2 etcd2配置 kubelet配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd2 ~]# cat /etc/kubernetes/kubelet  
KUBELET_ADDRESS=&#34;--address=0.0.0.0&#34;  
KUBELET_HOSTNAME=&#34;--hostname-override=192.168.126.136&#34;  #本机节点地址
KUBELET_API_SERVER=&#34;--api-servers=http://192.168.126.135:8080&#34;  # 主节点地址
KUBELET_POD_INFRA_CONTAINER=&#34;--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest&#34;  
KUBELET_ARGS=&#34;&#34;
</code></pre></div><p>config配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd2 ~]# cat /etc/kubernetes/config  
KUBE_LOGTOSTDERR=&#34;--logtostderr=true&#34;  
KUBE_LOG_LEVEL=&#34;--v=0&#34;  
KUBE_ALLOW_PRIV=&#34;--allow-privileged=false&#34;  
KUBE_MASTER=&#34;--master=http://192.168.126.135:8080&#34;  #主节点位置
</code></pre></div><p>启动：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">systemctl start kubelet  
systemctl start kube-proxy
</code></pre></div><p>4.3 etcd3配置 kubelet配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd3 ~]# cat /etc/kubernetes/kubelet  
KUBELET_ADDRESS=&#34;--address=0.0.0.0&#34;  
KUBELET_HOSTNAME=&#34;--hostname-override=192.168.126.137&#34;  #本机节点地址
KUBELET_API_SERVER=&#34;--api-servers=http://192.168.126.135:8080&#34;  # 主节点地址
KUBELET_POD_INFRA_CONTAINER=&#34;--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest&#34;  
KUBELET_ARGS=&#34;&#34;
</code></pre></div><p>config配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd3 ~]# cat /etc/kubernetes/config  
KUBE_LOGTOSTDERR=&#34;--logtostderr=true&#34;  
KUBE_LOG_LEVEL=&#34;--v=0&#34;  
KUBE_ALLOW_PRIV=&#34;--allow-privileged=false&#34;  
KUBE_MASTER=&#34;--master=http://192.168.126.135:8080&#34;  #主节点位置
</code></pre></div><p>启动：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">systemctl start kubelet  
systemctl start kube-proxy
</code></pre></div><p>检查配置结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# kubectl get nodes  
NAME              STATUS    AGE  
192.168.126.136   Ready     3h  
192.168.126.137   Ready     3h
</code></pre></div><h2 id="5-配置flanneld分布式网络">5. 配置flanneld分布式网络</h2>
<p>5.1 etcd1配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd1 ~]# cat /etc/sysconfig/flanneld  
FLANNEL_ETCD_ENDPOINTS=&#34;http://192.168.126.135:2379,http://192.168.126.136:2379,http://192.168.126.137:2379&#34;  #构成flanneld的分布式
FLANNEL_ETCD_PREFIX=&#34;/atomic.io/network&#34;  #此处值可以修改，对应etcd中存储的值
FLANNEL_OPTIONS=&#34;--logtostderr=false --log_dir=/var/log/flannel/ --iface=ens33&#34;  #此处ens33为自己物理网卡名称，必须一致
</code></pre></div><p>5.2 etcd2配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd2 ~]# cat /etc/sysconfig/flanneld  
FLANNEL_ETCD_ENDPOINTS=&#34;http://192.168.126.135:2379,http://192.168.126.136:2379,http://192.168.126.137:2379&#34;  #构成flanneld的分布式
FLANNEL_ETCD_PREFIX=&#34;/atomic.io/network&#34;  #此处值可以修改，对应etcd中存储的值
FLANNEL_OPTIONS=&#34;--logtostderr=false --log_dir=/var/log/flannel/ --iface=ens33&#34;  #此处ens33为自己物理网卡名称，必须一致
</code></pre></div><p>5.3 etcd3配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[root@etcd3 ~]# cat /etc/sysconfig/flanneld  
FLANNEL_ETCD_ENDPOINTS=&#34;http://192.168.126.135:2379,http://192.168.126.136:2379,http://192.168.126.137:2379&#34;  #构成flanneld的分布式
FLANNEL_ETCD_PREFIX=&#34;/atomic.io/network&#34;  #此处值可以修改，对应etcd中存储的值
FLANNEL_OPTIONS=&#34;--logtostderr=false --log_dir=/var/log/flannel/ --iface=ens33&#34;  #此处ens33为自己物理网卡名称，必须一致
</code></pre></div><p>5.4 为每个节点生成网络</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">etcdctl mk /atomic.io/network/config &#39;{&#34;Network&#34;:&#34;172.17.0.0/16&#34;}&#39;# 存入etcd数据库中，在任意节点执行
etcdctl get /atomic.io/network/config #查看 
systemctl restart flanneld  #启动
etcdctl ls /atomic.io/network/subnets 查看分配的网络 
/atomic.io/network/subnets/172.17.49.0-24 #第一个网段
/atomic.io/network/subnets/172.17.88.0-24 #第二个网段
/atomic.io/network/subnets/172.17.61.0-24 #第三个网段
</code></pre></div><p>5.5 重点，检查防火墙规则，在所有节点执行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">iptables -L -n  #查看防火墙规则  
iptables -P FORWARD ACCEPT ##转发
</code></pre></div><p>然后在etcd1 ping etcd2的flannel0网卡地址，和docker0网卡地址，互相测试，如果都可以连通，则证明flanneld分布式网络部署成功； 检查docker0和flannel0是否在同一网段，如否，则有问题； 启动顺序保证flanneld先启动，docker后启动，应为docker的网卡由flanneld分配</p>
<h2 id="6-部署dashboard">6. 部署Dashboard</h2>
<p><strong>坑</strong>：镜像registry.access.redhat.com/rhel7/pod-infrastructure无法下载，我们用docker提前直接下载，docker pull registry.access.redhat.com/rhel7/pod-infrastructure:latest 在etcd1进行创建，后续会由集群分发到不同的节点部署 dashboard-controller.yaml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: kubernetes-dashboard
  <span style="color:#66d9ef">namespace</span>: kube-system
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
    <span style="color:#66d9ef">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">9090</span>
[root@etcd1 ~]<span style="color:#75715e"># clear</span>
[root@etcd1 ~]<span style="color:#75715e"># cat dashboard-controller</span>
<span style="color:#66d9ef">cat: dashboard-controller</span>: No such file or directory
[root@etcd1 ~]<span style="color:#75715e"># cat dashboard-controller.yaml</span>
<span style="color:#66d9ef">apiVersion</span>: extensions/v1beta1
<span style="color:#66d9ef">kind</span>: Deployment
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: kubernetes-dashboard
  <span style="color:#66d9ef">namespace</span>: kube-system
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
    <span style="color:#66d9ef">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">matchLabels</span>:
      <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
  <span style="color:#66d9ef">template</span>:
    <span style="color:#66d9ef">metadata</span>:
      <span style="color:#66d9ef">labels</span>:
        <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
      <span style="color:#66d9ef">annotations</span>:
        <span style="color:#66d9ef">scheduler.alpha.kubernetes.io/critical-pod</span>: <span style="color:#e6db74">&#39;&#39;</span>
        <span style="color:#66d9ef">scheduler.alpha.kubernetes.io/tolerations</span>: <span style="color:#e6db74">&#39;[{&#34;key&#34;:&#34;CriticalAddonsOnly&#34;, &#34;operator&#34;:&#34;Exists&#34;}]&#39;</span>
    <span style="color:#66d9ef">spec</span>:
      <span style="color:#66d9ef">containers</span>:
      - <span style="color:#66d9ef">name</span>: kubernetes-dashboard
        <span style="color:#66d9ef">image</span>: bestwu/kubernetes-dashboard-amd64:v1<span style="color:#ae81ff">.6</span><span style="color:#ae81ff">.3</span>
        <span style="color:#66d9ef">resources</span>:
          <span style="color:#75715e"># keep request = limit to keep this container in guaranteed class</span>
          <span style="color:#66d9ef">limits</span>:
            <span style="color:#66d9ef">cpu</span>: 100m
            <span style="color:#66d9ef">memory</span>: 50Mi
          <span style="color:#66d9ef">requests</span>:
            <span style="color:#66d9ef">cpu</span>: 100m
            <span style="color:#66d9ef">memory</span>: 50Mi
        <span style="color:#66d9ef">ports</span>:
        - <span style="color:#66d9ef">containerPort</span>: <span style="color:#ae81ff">9090</span>
        <span style="color:#66d9ef">args</span>:
          - --apiserver-host=http://<span style="color:#ae81ff">192.168</span><span style="color:#ae81ff">.126</span><span style="color:#ae81ff">.135</span>:<span style="color:#ae81ff">8080</span>
        <span style="color:#66d9ef">livenessProbe</span>:
          <span style="color:#66d9ef">httpGet</span>:
            <span style="color:#66d9ef">path</span>: /
            <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">9090</span>
          <span style="color:#66d9ef">initialDelaySeconds</span>: <span style="color:#ae81ff">30</span>
          <span style="color:#66d9ef">timeoutSeconds</span>: <span style="color:#ae81ff">30</span>
</code></pre></div><p>dashboard-service.yaml:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: v1
<span style="color:#66d9ef">kind</span>: Service
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: kubernetes-dashboard
  <span style="color:#66d9ef">namespace</span>: kube-system
  <span style="color:#66d9ef">labels</span>:
    <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
    <span style="color:#66d9ef">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">selector</span>:
    <span style="color:#66d9ef">k8s-app</span>: kubernetes-dashboard
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">80</span>
    <span style="color:#66d9ef">targetPort</span>: <span style="color:#ae81ff">9090</span>
</code></pre></div><h2 id="7-测试使用">7. 测试使用</h2>
<p>访问浏览器<a href="https://192.168.126.135:6443/ui%E6%88%96%E8%80%85http://192.168.126.135:8080/ui">https://192.168.126.135:6443/ui或者http://192.168.126.135:8080/ui</a></p>
<h2 id="8-总结">8. 总结</h2>
<p>1） 全是高可用，分布式，集群，master可以使用多个，node可以使用多个，flanneld使用多个，etcd组成集群</p>
<p>2） 此文档未使用ca证书，之类，存在安全性风险，如果需要可以结合下</p>
<p>3） 本文写的过程中写了不少笔记，放在博客上，<a href="https://linjinbao66.github.io/">https://linjinbao66.github.io/</a></p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>作者:</span>
                <span>linjinbao66 </span>
                </p>
            
    </div>

    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>标签: 
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/k8s/">
                    #k8s</a></span>
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/kubernetes/">
                    #kubernetes</a></span>
            
            <span class="tag"><a href="https://linjinbao.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">
                    #分布式</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">返回</a></span> · 
                <span><a href="https://linjinbao.github.io">主页</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://linjinbao.github.io/2020/2020-01-24-etcd%E4%BD%BF%E7%94%A8/" class="prev" rel="prev" title="etcd使用"><i class="iconfont icon-left"></i>&nbsp;etcd使用</a>
         
        
        <a href="https://linjinbao.github.io/2020/2020-01-25-flannel%E7%BD%91%E7%BB%9C/" class="next" rel="next" title="flannel网络部署">flannel网络部署&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
		  <div id="utter-container"></div>
    <script src="https://utteranc.es/client.js"
        repo= 'linjinbao/linjinbao.github.io'
        issue-term= 'title'
        label= 'utterance'
        theme= 'github-dark-orange'
        crossorigin="anonymous"
        async>
    </script>

    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://linjinbao.github.io">linjinbao66</a>  </span> 
         

         
		 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
